#!/usr/bin/env bash

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if gsettings is available (GNOME systems)
if ! command -v gsettings &> /dev/null; then
  echo "⚠️  gsettings not found. This script is designed for GNOME Terminal."
  echo "   Terminal colors will not be applied automatically."
  exit 0
fi

# Check if GNOME Terminal schema is available
if ! gsettings list-schemas | grep -q "org.gnome.Terminal"; then
  echo "⚠️  GNOME Terminal not detected. Skipping terminal color application."
  exit 0
fi

# Check if terminal theme file exists
if [ ! -f "$SCRIPT_DIR/theme/terminal" ]; then
  echo "⚠️  Terminal theme file not found at $SCRIPT_DIR/theme/terminal"
  exit 1
fi

# Load terminal palette variables
source "$SCRIPT_DIR/theme/terminal"

# Detect default profile if PROFILE is not set or is empty
if [ -z "$PROFILE" ]; then
  # Get the default profile UUID from GNOME Terminal
  PROFILE=$(gsettings get org.gnome.Terminal.ProfilesList default 2>/dev/null | tr -d "'")
  
  if [ -z "$PROFILE" ]; then
    echo "⚠️  Could not detect GNOME Terminal profile. Skipping terminal color application."
    exit 0
  fi
fi

# Apply palette - try both path formats for compatibility
PROFILE_PATH="/org/gnome/terminal/legacy/profiles:/:$PROFILE"
SUCCESS=0

# Try the full path format first, fallback to short format
if gsettings set "org.gnome.Terminal.Legacy.Profile:$PROFILE_PATH" palette "$PALETTE" 2>/dev/null || \
   gsettings set "org.gnome.Terminal.Legacy.Profile:/:$PROFILE" palette "$PALETTE" 2>/dev/null; then
  SUCCESS=1
fi

if gsettings set "org.gnome.Terminal.Legacy.Profile:$PROFILE_PATH" background-color "$BACKGROUND" 2>/dev/null || \
   gsettings set "org.gnome.Terminal.Legacy.Profile:/:$PROFILE" background-color "$BACKGROUND" 2>/dev/null; then
  SUCCESS=1
fi

if gsettings set "org.gnome.Terminal.Legacy.Profile:$PROFILE_PATH" foreground-color "$FOREGROUND" 2>/dev/null || \
   gsettings set "org.gnome.Terminal.Legacy.Profile:/:$PROFILE" foreground-color "$FOREGROUND" 2>/dev/null; then
  SUCCESS=1
fi

if gsettings set "org.gnome.Terminal.Legacy.Profile:$PROFILE_PATH" cursor-background-color "$CURSOR" 2>/dev/null || \
   gsettings set "org.gnome.Terminal.Legacy.Profile:/:$PROFILE" cursor-background-color "$CURSOR" 2>/dev/null; then
  SUCCESS=1
fi

if [ $SUCCESS -eq 1 ]; then
  echo "✅ terminal colors applied from $SCRIPT_DIR/theme/terminal"
else
  echo "⚠️  Failed to apply terminal colors. The profile UUID might be incorrect."
  echo "   Try running: gsettings get org.gnome.Terminal.ProfilesList default"
fi
